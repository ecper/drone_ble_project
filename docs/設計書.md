# ドローン制御システム開発の設計書・フロー

このドキュメントは、Raspberry Pi 5、Arduino、モーター、そしてReact Native Expoで作成するiPhoneアプリを用いた自作ドローン制御システムの設計概要と開発フローを記述します。

## 1. システム全体像とコンポーネント

このドローン制御システムは、主に以下の3つの主要コンポーネントで構成されます。

**iPhoneアプリ (React Native Expo)**: ユーザーインターフェースを提供し、Bluetooth Low Energy (BLE) 経由でドローンの操作コマンドを送信し、状態を受信します。

**Raspberry Pi 5**: ドローン側のメインコントローラ。BLEペリフェラル（サーバー）としてiPhoneアプリと通信し、受信したコマンドをI2C経由でArduinoに転送します。また、Arduinoからの状態データをI2Cで受信し、BLE経由でiPhoneアプリに通知します。

**Arduino**: ドローンの低レベル制御（モーター/ESC制御、センサーデータ収集）を担当するマイクロコントローラ。I2CスレーブとしてRaspberry Piと通信します。

### 1.1. 通信フロー概要

**iPhoneアプリ → Raspberry Pi: BLE (Bluetooth Low Energy)**
- コマンド送信: スロットル、ピッチ、ロール、ヨーなどの飛行制御データ
- 状態受信: バッテリー残量、フライトモード、エラーメッセージなど

**Raspberry Pi → Arduino: I2C (Inter-Integrated Circuit)**
- コマンド転送: BLEで受信した飛行制御データをArduinoに送信
- 状態受信: Arduinoから収集したセンサーデータやドローン状態を受信

**Arduino → モーター (ESC): PWM (Pulse Width Modulation)**
- 受信したコマンドに基づき、ESC（Electronic Speed Controller）を介してブラシレスDCモーター（MT2204-2300KV）を制御

## 2. 各コンポーネントの詳細設計

### 2.1. iPhoneアプリ (React Native Expo)

**開発環境**: React Native, Expo SDK, react-native-ble-plx ライブラリ

**役割**:
- 直感的なUIでのドローン操作（ジョイスティック、ボタンなど）。
- BLEスキャン、デバイス選択、接続・切断機能。
- GATTサービス/キャラクタリスティックの発見と購読。
- COMMAND_CHARACTERISTIC への操作コマンド（例: "T1500,P10,R20,Y-5"）の文字列をUTF-8バイト列に変換し、Base64エンコードして送信。
- STATUS_CHARACTERISTIC からの通知データをBase64デコードし、UTF-8文字列として表示。

**権限**: app.json にBluetooth関連の権限設定を記述（iOS: NSBluetoothAlwaysUsageDescription, NSBluetoothPeripheralUsageDescription、Android: BLUETOOTH_CONNECT, BLUETOOTH_SCAN など）。

**実行環境**: Expo Dev Client を使用（react-native-ble-plx はExpo Goでは動作しないため）。

### 2.2. Raspberry Pi 5

**OS**: Raspberry Pi OS (Bookworm推奨)

**使用言語**: Python 3

**役割**:

**BLEペリフェラル (GATTサーバー)**:
- BlueZ D-Bus APIを直接利用し、カスタムBLEサービス (DRONE_SERVICE_UUID) をアドバタイズ。
- コマンド書き込みキャラクタリスティック (COMMAND_CHARACTERISTIC_UUID) を公開。
- ステータス通知キャラクタリスティック (STATUS_CHARACTERISTIC_UUID) を公開。
- COMMAND_CHARACTERISTIC への書き込みを検知し、I2Cコマンドに変換してArduinoに送信。
- ArduinoからのI2Cデータを受信し、STATUS_CHARACTERISTIC を介してiPhoneアプリに通知。

**I2Cマスター**:
- smbus2 ライブラリを使用してArduino（I2Cスレーブ）と通信。
- I2Cバスの初期化とコマンド（バイト列）の書き込み。
- I2Cバスからのステータスデータ（バイト列）の読み取り。

**主要ライブラリ**: dbus, dbus.mainloop.glib, gi.repository.GLib, smbus2, sys, logging

**設定**: sudo raspi-config でI2Cインターフェースを有効化。

**実行**: sudo python3 drone_ble_server.py (root権限で実行が必要)。

**I2Cアドレス**: Arduinoと共通のI2Cスレーブアドレスを設定 (例: 0x08)。

### 2.3. Arduino

**使用ボード**: ドローンの制御要件に合う任意のArduinoボード（例: Arduino Nano, ESP32 DevKitCなど）

**使用言語**: Arduino C++

**役割**:

**I2Cスレーブ**:
- Wire.h ライブラリを使用してI2C通信を初期化 (Wire.begin(SLAVE_ADDRESS))。
- Raspberry PiからのI2Cデータ（コマンド）を Wire.onReceive() イベントハンドラで受信・解析。
- Raspberry PiからのI2Cデータ要求を Wire.onRequest() イベントハンドラで処理し、ステータスデータを送信。

**モーター/ESC制御**:
- 受信したコマンド（スロットル、ピッチ、ロール、ヨーなど）に基づいて、ESCにPWM信号を生成し送信。
- IMU（慣性計測ユニット）などのセンサーから姿勢データなどを取得し、飛行安定化制御（PID制御など）を実行。

**状態監視**: バッテリー電圧、エラー状態などを監視し、I2C経由でRaspberry Piに送信するためのデータを準備。

**I2Cアドレス**: Raspberry Piと共通のI2Cスレーブアドレスを設定 (例: 0x08)。

**注意点**: Raspberry PiとArduino間のI2C接続では、ロジックレベルコンバーターの使用を強く推奨します。Raspberry Piは3.3V、Arduinoは5V（または3.3V）のロジックレベルであり、直接接続すると故障の原因や通信不安定になる可能性があります。

## 3. 開発フロー

以下のステップで開発を進めます。各ステップでテストを行い、問題なく動作することを確認しながら進めることが重要です。

### フェーズ1: Raspberry PiのBLE・I2C環境構築とテスト

**Raspberry Pi OSの更新と基本パッケージインストール**:
```bash
sudo apt update && sudo apt upgrade -y
sudo apt install python3-venv python3-pip bluez -y
```

sudo raspi-config でI2Cインターフェースを有効化。

**Python仮想環境セットアップとライブラリインストール**:
- プロジェクトディレクトリ作成、python3 -m venv venv、source venv/bin/activate。
- pip install pyserial smbus2 (smbus2はI2C用)。
- BlueZのPythonサンプルをダウンロードし、example-advertisement と example-gatt-server をプロジェクトディレクトリにコピー。

**Python BLEサーバーコード (drone_ble_server.py) の準備**:
- この設計書に記載された修正版コードをコピー。
- DRONE_SERVICE_UUID などのUUIDをご自身のユニークな値に置き換える。
- ARDUINO_I2C_ADDRESS を設定する。

**Arduino I2Cスレーブスケッチの準備**:
- Arduino IDEでI2Cスレーブとして動作するスケッチを作成。
- SLAVE_ADDRESS をPythonコードと一致させる。
- 基本的なI2Cコマンド受信と状態要求応答を実装（例: 単純なACK/NACK）。
- Arduinoにスケッチをアップロード。

**I2C物理接続とテスト**:
- Raspberry PiとArduinoをI2Cピンで接続（SDA, SCL, GND）。必要ならロジックレベルコンバーターを使用。
- sudo i2cdetect -y 1 でArduinoが検出されるか確認。
- Pythonコード実行前に、sudo systemctl disable bluetooth --now および sudo kill -9 <PID> で既存の bluetoothd プロセスを確実に終了させる。
- 新しいターミナルで sudo /usr/sbin/bluetoothd -d を実行し、デバッグログを監視。
- 別のターミナルで sudo python3 drone_ble_server.py を実行。
- bluetoothd -d のログに GATT Application registered successfully. が表示されるか確認。
- PythonスクリプトからI2Cコマンドを送信するテストコードを一時的に追加し、Arduinoのシリアルモニタで受信を確認。
- ArduinoからI2Cでダミーデータを送信するテストコードを記述し、Pythonスクリプトで受信を確認。

**BLEアドバタイズとGATTサービスの確認**:
- iPhoneのBLEスキャンアプリ（例: LightBlue, nRF Connect）で「RaspberryPiDrone」が見つかるか確認。
- 接続し、定義したサービスUUIDとキャラクタリスティックUUIDが見えるか確認。

### フェーズ2: iPhoneアプリ開発と連携テスト

**React Native Expoプロジェクトのセットアップ**:
- 新しいExpoプロジェクトを作成。
- npx expo install react-native-ble-plx、npm install buffer を実行。
- app.json にBluetooth権限設定を追加。

**iPhoneアプリのBLEクライアント実装**:
- この設計書に記載されたReact Native Expoアプリのコードを実装。
- GATT UUIDsをPythonコードと完全に一致させる。

**アプリのビルドと実行**:
- expo run:ios (または expo run:android) でExpo Dev Clientアプリをビルドし、iPhoneにインストールして実行。

**システム統合テスト**:
- iPhoneアプリから「RaspberryPiDrone」に接続。
- アプリのUIからコマンドを送信し、Raspberry Piのログ、Arduinoのシリアルモニタで受信を確認。
- ArduinoからのダミーデータがRaspberry Pi経由でiPhoneアプリに通知され、UIに表示されるか確認。

### フェーズ3: ドローン制御ロジックの実装と調整

**Arduinoフライトコントローラの実装**:
- IMUセンサー（ジャイロ、加速度計）からのデータ取得、姿勢推定。
- PID制御アルゴリズムの実装。
- ESCへのPWM信号出力によるモーター制御。
- バッテリー電圧監視など、フライトマネジメント機能。

**Raspberry Piの拡張**:
- （必要であれば）より高度な処理（画像認識、GPSナビゲーションなど）をPythonで実装。

**安全性テスト**:
- 緊急停止機能の動作確認。
- 安全な場所での低出力での動作テスト。