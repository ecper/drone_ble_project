# Bluetoothペアリング無効化手順

## 問題
BLE接続時にRaspberry Pi側でペアリング要求の承認が必要となり、ヘッドレス環境（GUIなし）では操作できない。

## 解決方法

### 方法1: 簡易設定（推奨）

1. **bluetoothctlで設定**
```bash
sudo bluetoothctl
```

以下のコマンドを順番に実行：
```
agent NoInputNoOutput
default-agent
pairable on
discoverable on
exit
```

2. **接続したデバイスを自動信頼**
iPhoneから一度接続した後：
```bash
# デバイスのMACアドレスを確認
sudo bluetoothctl devices

# デバイスを信頼（XX:XX:XX:XX:XX:XXは実際のMACアドレスに置換）
sudo bluetoothctl trust XX:XX:XX:XX:XX:XX
```

### 方法2: 自動化スクリプト（完全自動化）

1. **セットアップスクリプトを実行**
```bash
cd /home/uchida/Documents/fov-prog/drone_ble_project/raspberry_pi/
chmod +x setup_bluetooth_no_pairing.sh
sudo ./setup_bluetooth_no_pairing.sh
```

2. **drone_ble_server.pyを再起動**
```bash
sudo python3 drone_ble_server.py
```

### 方法3: 手動設定

1. **BlueZ設定ファイルを編集**
```bash
sudo nano /etc/bluetooth/main.conf
```

以下を追加または修正：
```ini
[General]
Name = RaspberryPiDrone
Class = 0x000000
PairableTimeout = 0
DiscoverableTimeout = 0

[Policy]
AutoEnable=true
```

2. **Bluetoothサービスを再起動**
```bash
sudo systemctl restart bluetooth
```

## 確認方法

### ペアリング状態の確認
```bash
# Bluetoothアダプターの状態確認
bluetoothctl show

# 期待される出力
Pairable: yes
Discoverable: yes
```

### 接続済みデバイスの確認
```bash
bluetoothctl devices
bluetoothctl info XX:XX:XX:XX:XX:XX
```

## BLEペリフェラルの特徴

BLE（Bluetooth Low Energy）ペリフェラルとして動作する場合：

1. **ペアリング不要で接続可能**
   - GATTサービスへの接続にペアリングは必須ではない
   - セキュリティレベルを下げることで自動接続が可能

2. **セキュリティレベル**
   - NoInputNoOutput: 確認不要（最も簡単）
   - JustWorks: 自動承認
   - 本番環境では適切なセキュリティレベルを検討

## トラブルシューティング

### それでもペアリング要求が出る場合

1. **既存のペアリング情報を削除**
```bash
# ペアリング済みデバイスを確認
bluetoothctl paired-devices

# ペアリング情報を削除
bluetoothctl remove XX:XX:XX:XX:XX:XX
```

2. **Bluetoothキャッシュをクリア**
```bash
sudo systemctl stop bluetooth
sudo rm -rf /var/lib/bluetooth/*
sudo systemctl start bluetooth
```

3. **iPhoneの設定**
- 設定 → Bluetooth → RaspberryPiDrone → 「このデバイスの登録を解除」
- 再度接続を試みる

### ログの確認
```bash
# Bluetoothサービスのログ
sudo journalctl -u bluetooth -f

# drone_ble_server.pyのログ
# 実行時のコンソール出力を確認
```

## セキュリティに関する注意

この設定により、誰でもBLEサービスに接続可能になります。本番環境では：

1. **MACアドレスフィルタリング**を検討
2. **特定のデバイスのみ信頼**する設定
3. **暗号化された通信**の実装

を検討してください。